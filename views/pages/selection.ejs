<%- include('../includes/head.ejs') %>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css' rel='stylesheet' />
    
    <!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">


</head>
<body>
  <style type="text/css">
    #info {
    display: table;
    position: relative;
    margin: 0px auto;
    word-wrap: anywhere;
    white-space: pre-wrap;
    padding: 10px;
    border: none;
    border-radius: 3px;
    font-size: 12px;
    text-align: center;
    color: #222;
    background: #fff;
    }
    </style>
  <main>
    <%- include('../includes/navigation.ejs') %>
  
  
    <div id="info"></div>
      <div class="container my-3">
        <% var test ="myString"; %> 
        <% if (prods.length > 0) { %>

          <div class="grid">
              <% for (let product of prods) { %>
                  <article class="card product-item">
                      <header class="card__header">
                          <h1 class="product__title"><%= product.city %></h1>
                      </header>
                     
                  </article>
              <% } %>
          </div>
      <% } else { %>
          <h1>No Products Found!</h1>
      <% } %>
  <div class="container">
    
    <div id="searchWrapper">
        <input
            type="text"
            name="searchBar"
            id="searchBar"
            placeholder="search for a character"
        />
    </div>

          <div
            id="map"
            style="width: 100%; height: 90vh;border-radius: 5px;"
          ></div>
        </div>
      </div>
  
      

        <script>
      
                   console.log("hey");
          let getTest = "<%= test %>";
          console.log(getTest);

          mapboxgl.accessToken = 'pk.eyJ1IjoiaGFycnliYXJjaWEiLCJhIjoiY2s3dzRvdTJnMDBqODNlbzhpcjdmaGxldiJ9.vg2wE4S7o_nryVx8IFIOuQ';
          const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            zoom: 11,
            center: [-123.1, 49.25]
            
            
          });
          map.addControl(
            new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl
            })
            );
            
          // Fetch stores from API
          async function getStores() {
            const res = await fetch('/products');
            const data = await res.json();
            console.log('data');
            console.log(data);
          try{
            const stores = data.map(store => {
              return {
          
                type: 'Feature',
                geometry: {
                  type: 'Point',
                  coordinates: [
                    store.location.coordinates[0],
                    store.location.coordinates[1]
                  ]
                },
                properties: {
                  _id: store._id,
                  storeId: store.storeId,
                  formattedAddress:store.location.formattedAddress,  
                  icon: 'shop',
                  image:store.image,
                  userId:store.userId,
                  city:store.city
                }
              };
            });
            loadMap(stores);
          }
          catch(err){
            console.log(err);
          }
          }
          
          // Load map with stores
          function loadMap(stores) {
            map.on('load', function() {
              map.addLayer({
                id: 'points',
                type: 'symbol',
                source: {
                  type: 'geojson',
                  data: {
                    type: 'FeatureCollection',
                    features: stores
                  }
                },
                layout: {
                  'icon-image': '{icon}-15',
                  'icon-size': 1.5,
                  'text-field': '{city}',
                  'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                  'text-offset': [0, 0.9],
                  'text-anchor': 'top'
                }
              });
            });
          }
          getStores();
          map.on('click', 'points', (e) => {
            // Copy coordinates array.
            const coordinates = e.features[0].geometry.coordinates.slice();
            const address = e.features[0].properties.formattedAddress;
            const image = e.features[0].properties.image;
            const storeId = e.features[0].properties._id;
            const userId = e.features[0].properties.userId;
            const city = e.features[0].properties.city;
             console.log(e.features);
            // Ensure that if the map is zoomed out such that multiple
            // copies of the feature are visible, the popup appears
            // over the copy being pointed to.
            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
            }
             
            new mapboxgl.Popup()
            .setLngLat(coordinates)
            .setHTML(`
              <img src='/images/${image}' style="width:100%;max-height:200px; border-radius:3%;max-height: 182px;object-fit: cover">
              <div>
              <span style="overflow: hidden;
                  text-overflow: ellipsis;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                          line-clamp: 3; 
                  -webkit-box-orient: vertical;
                  max-height: 60px;">
                </strong>
                ${city}
              </span>
              <span style="overflow: hidden;
                  text-overflow: ellipsis;
                  display: -webkit-box;
                  -webkit-line-clamp: 3;
                          line-clamp: 3; 
                  -webkit-box-orient: vertical;
                  max-height: 60px;">
                </strong>
                ${city}
              </span>
              </div>
              <a href='/stores/${storeId}' class="btn">Details</a>
              `)
            .addTo(map);
          });
          
          

        </script>
        

  </main>  
  <%- include('../includes/end.ejs') %>